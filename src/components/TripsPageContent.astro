---
import TripCard from "./TripCard.astro";
import SectionHeader from "./SectionHeader.astro";
import type { Trip, TripType } from "../types";
import { withBase } from "../utils/url";

interface PaginationMeta {
  currentPage: number;
  totalPages: number;
  totalPastTrips: number;
}

interface Props {
  upcomingTrips: Trip[];
  pastTrips: Trip[];
  pagination: PaginationMeta;
}

const { upcomingTrips, pastTrips, pagination } = Astro.props;

const tripTypes = ["hiking", "mountaineering", "ski"] as const;
const difficulties = [1, 2, 3, 4, 5];
const typeLabelMap: Record<(typeof tripTypes)[number], string> = {
  hiking: "Πεζοπορία",
  mountaineering: "Ορειβασία",
  ski: "Ski & Snowboard",
};
const typeFilterOptions: (TripType | "all")[] = ["all", ...tripTypes];
const difficultyFilterOptions: (number | "all")[] = ["all", ...difficulties];

const pageHref = (pageNumber: number, hash?: string) => {
  const base = pageNumber === 1
    ? withBase("/trips")
    : withBase(`/trips/page/${pageNumber}`);
  return hash ? `${base}${hash}` : base;
};
---

<section class="section-padding" data-reveal>
  <SectionHeader
    eyebrow="Ημερολόγιο"
    title="Χάρτης εξορμήσεων"
    subtitle="Διάλεξε εποχή, στόχο ή κύκλο καθοδήγησης"
  />
  <div class="glass-panel p-6 mb-12">
    <p class="text-sm uppercase tracking-[0.3em] text-brand-mist">
      Φίλτρα (ενδεικτικά)
    </p>
    <div class="mt-4 flex flex-wrap gap-3">
      {
        typeFilterOptions.map((typeOption) => (
          <button
            class="rounded-full border border-brand-river/30 bg-brand-cloud px-4 py-2 text-sm text-brand-rocky shadow-sm hover:-translate-y-0.5"
            data-filter-type={typeOption}
          >
            {typeOption === "all"
              ? "Όλες οι δραστηριότητες"
              : typeLabelMap[typeOption]}
          </button>
        ))
      }
    </div>
    <div class="mt-4 flex flex-wrap gap-3">
      {
        difficultyFilterOptions.map((level) => (
          <button
            class="rounded-full border border-brand-river/20 bg-brand-cloud px-4 py-2 text-sm text-brand-mist shadow-sm hover:-translate-y-0.5"
            data-filter-difficulty={level}
          >
            {level === "all" ? "Όλες οι δυσκολίες" : `Δυσκολία ${level}`}
          </button>
        ))
      }
    </div>
  </div>
  <div class="space-y-16">
    <div>
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-semibold text-brand-cloud">
          Επόμενες εξορμήσεις
        </h3>
        <span class="text-sm text-brand-mist"
          >{upcomingTrips.length} διαδρομές</span
        >
      </div>
      {
        upcomingTrips.length > 0 ? (
          <div class="grid gap-6 lg:grid-cols-2">
            {upcomingTrips.map((trip) => <TripCard trip={trip} />)}
          </div>
        ) : (
          <div class="glass-panel p-6 text-brand-mist">
            <p class="text-lg font-semibold text-brand-cloud">
              Δεν υπάρχουν επόμενες εξορμήσεις στο ημερολόγιο.
            </p>
            <p class="mt-2">
              Επιστρέψτε σύντομα ή εξερευνήστε τις προηγούμενες αναφορές για να δείτε τι ακολουθεί συνήθως το πρόγραμμά μας.
            </p>
          </div>
        )
      }
    </div>
    <div
      id="past-trips"
      style="scroll-margin-top: 5rem;"
      class="space-y-6"
    >
      <div class="flex items-center justify-between mb-0">
        <h3 class="text-2xl font-semibold text-brand-cloud">
          Αναφορές προηγούμενων
        </h3>
        <span class="text-sm text-brand-mist"
          >{pagination.totalPastTrips} αναφορές</span
        >
      </div>
      {
        pastTrips.length > 0 ? (
          <div class="grid gap-6 lg:grid-cols-2">
            {pastTrips.map((trip) => <TripCard trip={trip} />)}
          </div>
        ) : (
          <div class="glass-panel p-6 text-brand-mist">
            <p class="text-lg font-semibold text-brand-cloud">
              Δεν υπάρχουν προηγούμενες εξορμήσεις προς το παρόν.
            </p>
            <p class="mt-2">
              Μείνε συντονισμένος για νέες αναφορές από την κοινότητά μας.
            </p>
          </div>
        )
      }
      {
        pagination.totalPages > 1 && (
          <div class="mt-6 flex flex-wrap items-center gap-4 justify-between border-t border-brand-cloud/10 pt-4">
            <span class="text-sm text-brand-mist">
              Σελίδα {pagination.currentPage} από {pagination.totalPages}
            </span>
            <div class="flex gap-3">
              {
                pagination.currentPage > 1 && (
                  <a
                    href={pageHref(pagination.currentPage - 1, '#past-trips')}
                    class="rounded-full border border-brand-cloud/40 px-4 py-2 text-sm font-semibold text-brand-cloud hover:border-brand-terracotta"
                  >
                    Προηγούμενη
                  </a>
                )
              }
              {
                pagination.currentPage < pagination.totalPages && (
                  <a
                    href={pageHref(pagination.currentPage + 1, '#past-trips')}
                    class="rounded-full border border-brand-cloud/40 px-4 py-2 text-sm font-semibold text-brand-cloud hover:border-brand-terracotta"
                  >
                    Επόμενη
                  </a>
                )
              }
            </div>
          </div>
        )
      }
    </div>
  </div>
</section>
<script>
  (() => {
    const typeButtons = document.querySelectorAll<HTMLButtonElement>(
      '[data-filter-type]'
    );
    const difficultyButtons = document.querySelectorAll<HTMLButtonElement>(
      '[data-filter-difficulty]'
    );
    const cards = document.querySelectorAll<HTMLElement>('[data-trip-card]');
    let activeType = "all";
    let activeDifficulty = "all";

    const setActive = (
      buttons: NodeListOf<HTMLButtonElement>,
      activeValue: string,
      attr: string
    ) => {
      buttons.forEach((button) => {
        const value = button.getAttribute(attr) ?? "all";
        button.classList.toggle("filter-active", value === activeValue);
      });
    };

    const applyFilters = () => {
      cards.forEach((card) => {
        const type = card.getAttribute("data-type") ?? "";
        const difficulty = card.getAttribute("data-difficulty") ?? "";
        const matchesType = activeType === "all" || type === activeType;
        const matchesDifficulty =
          activeDifficulty === "all" || difficulty === activeDifficulty;
        card.classList.toggle("hidden", !(matchesType && matchesDifficulty));
      });
    };

    typeButtons.forEach((button) => {
      button.addEventListener("click", () => {
        activeType = button.getAttribute("data-filter-type") ?? "all";
        setActive(typeButtons, activeType, "data-filter-type");
        applyFilters();
      });
    });

    difficultyButtons.forEach((button) => {
      button.addEventListener("click", () => {
        activeDifficulty =
          button.getAttribute("data-filter-difficulty") ?? "all";
        setActive(
          difficultyButtons,
          activeDifficulty,
          "data-filter-difficulty"
        );
        applyFilters();
      });
    });

    setActive(typeButtons, activeType, "data-filter-type");
    setActive(difficultyButtons, activeDifficulty, "data-filter-difficulty");
    applyFilters();
  })();
</script>
