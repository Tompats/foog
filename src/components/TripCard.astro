---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import type { Trip } from "../types";
import { getTripTimelineStatus } from "../types";
import hikingCardImage from "../assets/cards/hiking-card.jpg";
import mountaineeringCardImage from "../assets/cards/mountaineering-card.jpg";
import skiCardImage from "../assets/cards/ski-card.jpg";
import { withBase } from "../utils/url";

interface Props {
  trip: Trip;
}

const { trip } = Astro.props;

const monthFormatter = new Intl.DateTimeFormat("el-GR", { month: "short" });
const dayFormatter = new Intl.DateTimeFormat("el-GR", { day: "2-digit" });
const yearFormatter = new Intl.DateTimeFormat("el-GR", { year: "numeric" });
const startDate = new Date(trip.startDate);
const endDate = trip.endDate ? new Date(trip.endDate) : null;

const isSameDay = !endDate || startDate.getTime() === endDate.getTime();
const isSameMonthYear =
  !!endDate &&
  startDate.getMonth() === endDate.getMonth() &&
  startDate.getFullYear() === endDate.getFullYear();

let formattedDate = `${dayFormatter.format(startDate)} ${monthFormatter.format(startDate)} ${yearFormatter.format(startDate)}`;
if (endDate && !isSameDay) {
  if (isSameMonthYear) {
    formattedDate = `${dayFormatter.format(startDate)}-${dayFormatter.format(endDate)} ${monthFormatter.format(startDate)} ${yearFormatter.format(startDate)}`;
  } else {
    formattedDate = `${dayFormatter.format(startDate)} ${monthFormatter.format(startDate)} ${yearFormatter.format(startDate)} - ${dayFormatter.format(endDate)} ${monthFormatter.format(endDate)} ${yearFormatter.format(endDate)}`;
  }
}

const typeStyles: Record<Trip["type"], string> = {
  hiking: "bg-emerald-50 text-emerald-700 border-emerald-200",
  mountaineering: "bg-indigo-50 text-indigo-700 border-indigo-200",
  ski: "bg-sky-50 text-sky-700 border-sky-200",
};

const typeLabels: Record<Trip["type"], string> = {
  hiking: "Πεζοπορία",
  mountaineering: "Ορειβασία",
  ski: "Ski & Snowboard",
};
const typeImages: Record<Trip["type"], ImageMetadata> = {
  hiking: hikingCardImage,
  mountaineering: mountaineeringCardImage,
  ski: skiCardImage,
};

const timelineStatus = getTripTimelineStatus(trip);

const timelineLabels = {
  upcoming: "Επόμενη",
  past: "Παλαιότερη",
};

type StatusVariant = "upcoming" | "past" | "canceled";

const statusVariant: StatusVariant =
  trip.status === "canceled" ? "canceled" : timelineStatus;

const statusLabel =
  statusVariant === "canceled" ? "Ακυρωμένη" : timelineLabels[timelineStatus];

const statusTextClasses: Record<StatusVariant, string> = {
  upcoming: "text-brand-mossDark",
  past: "text-brand-river",
  canceled: "text-brand-terracotta",
};

// Ski trips place emphasis on flow rather than metrics, so hide the technical stats.
const shouldShowTechnicalStats = trip.type !== "ski";
---

<article
  class="glass-panel p-0 overflow-hidden transition duration-300 hover:-translate-y-1 hover:shadow-glow hover:border-brand-pine/30"
  data-trip-card
  data-type={trip.type}
  data-difficulty={trip.difficulty}
>
  <div class="h-40 w-full overflow-hidden relative">
    <Image
      src={typeImages[trip.type]}
      alt={trip.title}
      class="h-full w-full object-cover"
      loading="lazy"
    />
    <div
      class="absolute inset-0 bg-gradient-to-t from-brand-river/70 via-transparent to-transparent"
    >
    </div>
  </div>
  <div
    class="p-6 flex flex-col gap-5 bg-gradient-to-br from-brand-river/10 via-brand-cloud to-brand-river/5"
  >
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <p
          class="text-s font-bold uppercase tracking-[0.35em] text-brand-mossDark"
        >
          {formattedDate}
        </p>
        <p class="text-lg font-semibold text-brand-rocky heading-font">
          {trip.location}
        </p>
      </div>
      <span
        class={`inline-flex items-center gap-2 text-xs font-semibold px-3 py-1 rounded-full border shadow-sm ${typeStyles[trip.type]} `}
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          class="h-3.5 w-3.5"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="m6 15 3.5-4.5L13 15l3-3 2 2"></path>
        </svg>
        {typeLabels[trip.type]}
      </span>
    </div>
    <div>
      <h3 class="text-2xl font-semibold text-brand-rocky heading-font">
        {trip.title}
      </h3>
      <p class="mt-2 text-brand-mist leading-relaxed">
        {trip.shortDescription}
      </p>
    </div>
    <div class="space-y-3">
      {
        shouldShowTechnicalStats && (
          <div class="flex items-center gap-3 text-sm text-brand-mist">
            <span class="uppercase tracking-[0.3em] text-xs text-brand-river">
              Δυσκολία
            </span>
            <div
              class="flex gap-1"
              aria-label={`Επίπεδο δυσκολίας ${trip.difficulty} από 5`}
            >
              {Array.from({ length: 5 }).map((_, index) => (
                <span
                  class={`h-2.5 w-8 rounded-full transition ${index < trip.difficulty ? "bg-brand-terracotta shadow-inner shadow-brand-terracotta/40" : "bg-brand-river/40"}`}
                />
              ))}
            </div>
          </div>
        )
      }
      <div class="grid grid-cols-2 gap-4 text-sm text-brand-rocky">
        {
          shouldShowTechnicalStats && (
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-brand-mist">
                Απόσταση
              </p>
              <p class="text-lg font-semibold heading-font">
                {trip.distanceKm} km
              </p>
            </div>
          )
        }
        {
          shouldShowTechnicalStats && (
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-brand-mist">
                Υψομετρική
              </p>
              <p class="text-lg font-semibold heading-font">
                {trip.elevationGain} m
              </p>
            </div>
          )
        }
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-brand-mist">
            Αρχηγός
          </p>
          <p class="text-lg font-semibold heading-font">{trip.leader}</p>
        </div>
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-brand-mist">
            Κατάσταση
          </p>
          <p
            class={`text-lg font-semibold heading-font ${statusTextClasses[statusVariant]}`}
          >
            {statusLabel}
          </p>
        </div>
      </div>
    </div>
    <div class="pt-2">
      <a
        href={withBase(`/trips/${trip.slug}`)}
        class="inline-flex items-center gap-2 text-sm font-semibold text-brand-pine rounded-full border border-brand-pine/20 px-4 py-2 transition hover:-translate-y-0.5 hover:border-brand-terracotta hover:text-brand-terracotta"
      >
        Λεπτομέρειες
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          class="h-4 w-4"
          fill="none"
          stroke="currentColor"
          stroke-width="1.5"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M5 12h14m-6-6 6 6-6 6"></path>
        </svg>
      </a>
    </div>
  </div>
</article>
