---
import BaseLayout from "../layouts/BaseLayout.astro";
import TripCard from "../components/TripCard.astro";
import SectionHeader from "../components/SectionHeader.astro";
import { trips } from "../data/trips";
import type { TripType } from "../types";
import { isTripUpcoming, isTripPast } from "../types";
import { createCollectionPageJsonLd } from "../utils/seo";

const upcomingTrips = [...trips]
  .filter((trip) => isTripUpcoming(trip))
  .sort((a, b) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime());

const pastTrips = [...trips]
  .filter((trip) => isTripPast(trip))
  .sort((a, b) => new Date(b.startDate).getTime() - new Date(a.startDate).getTime());

const tripTypes = ["hiking", "mountaineering", "ski"] as const;
const difficulties = [1, 2, 3, 4, 5];
const typeLabelMap: Record<(typeof tripTypes)[number], string> = {
  hiking: "Πεζοπορία",
  mountaineering: "Ορειβασία",
  ski: "Ski & Snowboard",
};
const typeFilterOptions: (TripType | "all")[] = ["all", ...tripTypes];
const difficultyFilterOptions: (number | "all")[] = ["all", ...difficulties];

const tripsStructuredData = createCollectionPageJsonLd(
  "Χάρτης εξορμήσεων Φ.Ο.Ο.Γ.",
  Astro.url.href
);
---

<BaseLayout
  title="Εξορμήσεις"
  description="Δες τις επόμενες και παλαιότερες εξορμήσεις του Φ.Ο.Ο.Γ., ταξινόμησε ανά δραστηριότητα και δυσκολία και όρισε τον επόμενο στόχο σου."
  structuredData={[tripsStructuredData]}
>
  <section class="section-padding">
    <SectionHeader
      eyebrow="Ημερολόγιο"
      title="Χάρτης εξορμήσεων"
      subtitle="Διάλεξε εποχή, στόχο ή κύκλο καθοδήγησης"
    />
    <div class="glass-panel p-6 mb-12">
      <p class="text-sm uppercase tracking-[0.3em] text-brand-mist">
        Φίλτρα (ενδεικτικά)
      </p>
      <div class="mt-4 flex flex-wrap gap-3">
        {
          typeFilterOptions.map((typeOption) => (
            <button
              class="rounded-full border border-brand-river/30 bg-brand-cloud px-4 py-2 text-sm text-brand-rocky shadow-sm hover:-translate-y-0.5"
              data-filter-type={typeOption}
            >
              {typeOption === "all"
                ? "Όλες οι δραστηριότητες"
                : typeLabelMap[typeOption]}
            </button>
          ))
        }
      </div>
      <div class="mt-4 flex flex-wrap gap-3">
        {
          difficultyFilterOptions.map((level) => (
            <button
              class="rounded-full border border-brand-river/20 bg-brand-cloud px-4 py-2 text-sm text-brand-mist shadow-sm hover:-translate-y-0.5"
              data-filter-difficulty={level}
            >
              {level === "all" ? "Όλες οι δυσκολίες" : `Δυσκολία ${level}`}
            </button>
          ))
        }
      </div>
    </div>
    <div class="space-y-16">
      <div>
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-2xl font-semibold text-brand-cloud">
            Επόμενες εξορμήσεις
          </h3>
          <span class="text-sm text-brand-mist"
            >{upcomingTrips.length} διαδρομές</span
          >
        </div>
        {
          upcomingTrips.length > 0 ? (
            <div class="grid gap-6 lg:grid-cols-2">
              {upcomingTrips.map((trip) => <TripCard trip={trip} />)}
            </div>
          ) : (
            <div class="glass-panel p-6 text-brand-mist">
              <p class="text-lg font-semibold text-brand-cloud">
                Δεν υπάρχουν επόμενες εξορμήσεις στο ημερολόγιο.
              </p>
              <p class="mt-2">
                Επιστρέψτε σύντομα ή εξερευνήστε τις προηγούμενες αναφορές για να δείτε τι ακολουθεί συνήθως το πρόγραμμά μας.
              </p>
            </div>
          )
        }
      </div>
      <div>
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-2xl font-semibold text-brand-cloud">
            Αναφορές προηγούμενων
          </h3>
          <span class="text-sm text-brand-mist"
            >{pastTrips.length} αναφορές</span
          >
        </div>
        <div class="grid gap-6 lg:grid-cols-2">
          {pastTrips.map((trip) => <TripCard trip={trip} />)}
        </div>
      </div>
    </div>
  </section>
  <script>
    (() => {
      const typeButtons = document.querySelectorAll<HTMLButtonElement>(
        '[data-filter-type]'
      );
      const difficultyButtons = document.querySelectorAll<HTMLButtonElement>(
        '[data-filter-difficulty]'
      );
      const cards = document.querySelectorAll<HTMLElement>('[data-trip-card]');
      let activeType = "all";
      let activeDifficulty = "all";

      const setActive = (
        buttons: NodeListOf<HTMLButtonElement>,
        activeValue: string,
        attr: string
      ) => {
        buttons.forEach((button) => {
          const value = button.getAttribute(attr) ?? "all";
          button.classList.toggle("filter-active", value === activeValue);
        });
      };

      const applyFilters = () => {
        cards.forEach((card) => {
          const type = card.getAttribute("data-type") ?? "";
          const difficulty = card.getAttribute("data-difficulty") ?? "";
          const matchesType = activeType === "all" || type === activeType;
          const matchesDifficulty =
            activeDifficulty === "all" || difficulty === activeDifficulty;
          card.classList.toggle("hidden", !(matchesType && matchesDifficulty));
        });
      };

      typeButtons.forEach((button) => {
        button.addEventListener("click", () => {
          activeType = button.getAttribute("data-filter-type") ?? "all";
          setActive(typeButtons, activeType, "data-filter-type");
          applyFilters();
        });
      });

      difficultyButtons.forEach((button) => {
        button.addEventListener("click", () => {
          activeDifficulty =
            button.getAttribute("data-filter-difficulty") ?? "all";
          setActive(
            difficultyButtons,
            activeDifficulty,
            "data-filter-difficulty"
          );
          applyFilters();
        });
      });

      setActive(typeButtons, activeType, "data-filter-type");
      setActive(difficultyButtons, activeDifficulty, "data-filter-difficulty");
      applyFilters();
    })();
  </script>
</BaseLayout>
